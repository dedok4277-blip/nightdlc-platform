# Интеграция лаунчера с сайтом - Готово! ✅

## Что было сделано

### 1. Конфигурация API
- ✅ Создан файл `NelonLauncher/config.js` с настройками API
- ✅ URL автоматически переключается между dev и production
- ✅ Production URL: `https://cz505339.tw1.ru/api`

### 2. Система регистрации
- ✅ Добавлен экран регистрации в лаунчере
- ✅ Валидация полей (username, email, password)
- ✅ Автоматическая привязка HWID после регистрации
- ✅ Переключение между экранами Login/Register

### 3. Интеграция с существующей системой
- ✅ Лаунчер использует те же API endpoints, что и сайт
- ✅ JWT токены совместимы
- ✅ HWID защита работает автоматически
- ✅ Проверка подписки перед запуском игры

### 4. Документация
- ✅ `NelonLauncher/README.md` - техническая документация
- ✅ `NelonLauncher/INTEGRATION.md` - детали интеграции
- ✅ `NelonLauncher/SETUP.md` - инструкция для пользователей

## Как это работает

### Регистрация через лаунчер

1. Пользователь нажимает "Register" в лаунчере
2. Заполняет форму (username, email, password)
3. Лаунчер отправляет `POST /api/auth/register`
4. Сервер создает аккаунт в базе данных
5. Автоматически выполняется вход с привязкой HWID
6. Пользователь попадает на главный экран

### Вход через лаунчер

1. Пользователь вводит username/email и password
2. Лаунчер генерирует HWID компьютера
3. Отправляет `POST /api/auth/login` с HWID
4. Сервер проверяет:
   - Правильность логина/пароля
   - Совпадение HWID (если уже привязан)
   - Если HWID не привязан - привязывает автоматически
5. Возвращает JWT токен и данные пользователя
6. Лаунчер сохраняет токен локально

### Проверка подписки

1. При загрузке главного экрана лаунчер запрашивает `GET /api/me`
2. Получает данные пользователя включая:
   - `subscriptionActive` - активна ли подписка
   - `subscriptionTier` - тип подписки (Basic/Plus/Elite)
   - `subscriptionExpiresAt` - дата окончания (0 = навсегда)
3. Кнопка "Launch" активна только если `subscriptionActive === true`

## Тестирование

### Локальное тестирование

```bash
# Терминал 1: Запустите сервер сайта
cd "Site For NightDLC"
npm run api

# Терминал 2: Запустите лаунчер
cd NelonLauncher
npm start
```

### Тест регистрации

1. Запустите лаунчер
2. Нажмите "Register"
3. Заполните форму:
   - Username: `testuser`
   - Email: `test@example.com`
   - Password: `test123`
4. Нажмите "Create Account"
5. Должен произойти автоматический вход

### Тест входа

1. Выйдите из аккаунта (кнопка Logout)
2. Введите данные:
   - Username: `testuser`
   - Password: `test123`
3. Нажмите "Continue"
4. Должен произойти вход

### Тест HWID защиты

1. Войдите в админ-панель на сайте
2. Найдите пользователя `testuser`
3. Установите другой HWID вручную в базе данных
4. Попробуйте войти в лаунчер
5. Должна появиться ошибка "Invalid HWID"
6. Сбросьте HWID через админ-панель
7. Войдите снова - должно работать

## Деплой

### 1. Настройка production URL

Файл `NelonLauncher/config.js` уже настроен на production URL:
```javascript
API_URL: 'https://cz505339.tw1.ru/api'
```

### 2. Сборка лаунчера

```bash
cd NelonLauncher
set NODE_ENV=production
npm run build:win
```

Установщик будет создан в папке `dist/`.

### 3. Распространение

1. Загрузите установщик на сайт
2. Пользователи скачивают и устанавливают
3. При первом запуске лаунчер подключится к production серверу

## API Endpoints используемые лаунчером

| Endpoint | Метод | Описание | Используется для |
|----------|-------|----------|------------------|
| `/api/auth/register` | POST | Регистрация | Создание нового аккаунта |
| `/api/auth/login` | POST | Вход с HWID | Аутентификация и привязка HWID |
| `/api/me` | GET | Данные пользователя | Проверка подписки и отображение профиля |

## Структура данных

### Запрос регистрации
```json
{
  "username": "player123",
  "email": "player@example.com",
  "password": "securepass"
}
```

### Запрос входа
```json
{
  "login": "player123",
  "password": "securepass",
  "hwid": "abc123def456..."
}
```

### Ответ сервера
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "uid": "123456789",
    "username": "player123",
    "email": "player@example.com",
    "avatarUrl": "/uploads/avatar.jpg",
    "isAdmin": false,
    "subscriptionActive": true,
    "subscriptionTier": "Elite",
    "subscriptionExpiresAt": 0,
    "hwid": "abc123def456..."
  }
}
```

## Безопасность

### JWT токены
- ✅ Действительны 7 дней
- ✅ Хранятся локально в `%APPDATA%/nelon-launcher/user.json`
- ✅ Автоматически используются для всех запросов

### HWID защита
- ✅ Генерируется из характеристик компьютера
- ✅ Привязывается автоматически при первом входе
- ✅ Проверяется при каждом входе
- ✅ Сброс только через админ-панель

### Пароли
- ✅ Хешируются на сервере с bcrypt
- ✅ Никогда не хранятся в открытом виде
- ✅ Минимум 6 символов

## Возможные проблемы и решения

### "Cannot connect to server"

**Причина**: Сервер недоступен или неверный URL

**Решение**:
1. Проверьте, что сервер запущен
2. Проверьте URL в `config.js`
3. Проверьте CORS настройки на сервере

**Проверка CORS** в `Site For NightDLC/server/index.js`:
```javascript
app.use(cors()) // Должно быть включено
```

### "Invalid HWID"

**Причина**: Аккаунт привязан к другому компьютеру

**Решение**:
1. Войдите в админ-панель: `https://cz505339.tw1.ru/admin`
2. Найдите пользователя
3. Нажмите "Reset HWID"

### Кнопка Launch неактивна

**Причина**: Нет активной подписки

**Решение**:
1. Войдите в админ-панель
2. Выдайте подписку пользователю:
   ```bash
   cd "Site For NightDLC"
   node give-elite.js testuser
   ```
3. Или активируйте лицензионный ключ на сайте

## Следующие шаги

### Для пользователей

1. ✅ Регистрация работает через лаунчер
2. ✅ Вход работает с учетными данными сайта
3. ✅ HWID защита активна
4. ✅ Проверка подписки работает

### Для администраторов

1. ✅ Управление пользователями через админ-панель
2. ✅ Сброс HWID через админ-панель
3. ✅ Выдача подписок через админ-панель
4. ✅ Генерация ключей через админ-панель

## Дополнительные возможности

### Автоматический вход
Лаунчер сохраняет токен и автоматически входит при следующем запуске.

### Отображение аватара
Если пользователь загрузил аватар на сайте, он отображается в лаунчере.

### Информация о подписке
Лаунчер показывает тип подписки и дату окончания.

### Темы оформления
Поддержка светлой и темной темы с сохранением настроек.

## Контакты

При возникновении проблем:
1. Проверьте логи сервера: `pm2 logs nelondlc`
2. Проверьте логи лаунчера: DevTools (Ctrl+Shift+I)
3. Проверьте базу данных: `node show-users.js`

---

**Статус**: ✅ Готово к использованию  
**Версия лаунчера**: 0.1.0  
**Версия API**: 1.0.0  
**Дата**: Февраль 2026
